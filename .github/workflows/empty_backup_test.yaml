name: supabase-backup-test

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *" # Runs every day at midnight

env:
  BACKUP_ENABLED: true

jobs:
  run_db_backup:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
      BACKUP_ENABLED: ${{ vars.BACKUP_ENABLED }} # Repository variable (true or false)
    
    steps:
      - name: Set TIMESTAMP variable
        run: echo "TIMESTAMP=$(date +'%Y-%m-%d_%H-%M-%S')" >> $GITHUB_ENV

  restore_staging_db:
   needs: run_db_backup
   uses: ./.github/workflows/restore_staging_db.yaml
  with:
    supabase_db_url: ${{ env.MY_DB_SECRET }}
  env:
    MY_DB_SECRET: ${{ secrets.SUPABASE_DB_URL }}